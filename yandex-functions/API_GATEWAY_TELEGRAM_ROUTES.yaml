# ========================================
# TELEGRAM MINI APP МАРШРУТЫ ДЛЯ API GATEWAY
# ========================================
# 
# ИНСТРУКЦИЯ:
# 1. Скопируйте все маршруты (начиная с "paths:")
# 2. Вставьте их в ваш основной api-gateway-spec.yaml в конец раздела paths
# 3. Замените ТОЛЬКО <SERVICE_ACCOUNT_ID> на ID вашего сервисного аккаунта
# 4. Сохраните и обновите API Gateway
#
# ФУНКЦИИ УЖЕ ВСТАВЛЕНЫ:
# - telegram-auth: d4em719picvakgi4ng2s ✅
# - send-order-to-user-telegram: d4epu4u7dq6u9ni5tfbo ✅
#

paths:
  # Привязка Telegram ID к аккаунту пользователя
  /api/telegram/auth:
    post:
      summary: Привязка Telegram ID к аккаунту пользователя
      description: Проверяет подпись от Telegram Web App и привязывает Telegram ID к аккаунту пользователя
      operationId: telegramAuth
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - initData
                - email
              properties:
                initData:
                  type: string
                  description: Данные от Telegram Web App (window.Telegram.WebApp.initData)
                  example: "query_id=AAHdF6IQAAAAO0Xng..."
                email:
                  type: string
                  format: email
                  description: Email пользователя Sweet Delights
                  example: "user@example.com"
      x-yc-apigateway-integration:
        type: cloud_functions
        function_id: d4em719picvakgi4ng2s
        service_account_id: aje47rf2630q59equess
      responses:
        '200':
          description: Telegram ID успешно привязан
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                  user:
                    type: object
                    properties:
                      email:
                        type: string
                      userId:
                        type: string
                      telegramId:
                        type: string
                      telegramUsername:
                        type: string
        '400':
          description: Неверные параметры или отсутствуют обязательные поля
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                  code:
                    type: string
        '401':
          description: Неверная подпись от Telegram
        '404':
          description: Пользователь не найден
        '409':
          description: К этому аккаунту уже привязан другой Telegram ID
        '500':
          description: Ошибка сервера
    options:
      summary: CORS preflight
      operationId: telegramAuthOptions
      x-yc-apigateway-integration:
        type: dummy
        http_code: 200
        http_headers:
          Access-Control-Allow-Origin: "'*'"
          Access-Control-Allow-Methods: "'POST, OPTIONS'"
          Access-Control-Allow-Headers: "'Content-Type, Authorization'"
      responses:
        '200':
          description: CORS response

  # Отправка уведомления заказа пользователю в Telegram
  /api/send-order-to-user-telegram:
    post:
      summary: Отправка уведомления о заказе в личный Telegram чат пользователя
      description: Получает данные заказа и отправляет красивое форматированное уведомление пользователю в его личный Telegram чат
      operationId: sendOrderToUserTelegram
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - orderData
              properties:
                orderData:
                  type: object
                  required:
                    - id
                    - customerName
                    - customerEmail
                    - items
                    - total
                  properties:
                    id:
                      type: string
                      description: ID заказа
                      example: "order-123abc"
                    customerName:
                      type: string
                      description: ФИО получателя
                      example: "Иван Петров"
                    customerEmail:
                      type: string
                      format: email
                      description: Email получателя
                      example: "ivan@example.com"
                    customerPhone:
                      type: string
                      description: Телефон получателя (опционально)
                    items:
                      type: array
                      description: Массив товаров в заказе
                      items:
                        type: object
                        properties:
                          name:
                            type: string
                          quantity:
                            type: number
                          price:
                            type: number
                    total:
                      type: number
                      description: Итоговая сумма заказа
                      example: 5000
                    subtotal:
                      type: number
                      description: Сумма без скидки (опционально)
                    discount:
                      type: number
                      description: Размер скидки (опционально)
                    promoCode:
                      type: string
                      description: Промокод (опционально)
                    shippingAddress:
                      type: string
                      description: Адрес доставки
                    createdAt:
                      type: string
                      format: date-time
                      description: Время создания заказа
                    deliveryService:
                      type: string
                      enum: [CDEK, POST, OTHER]
                      description: Служба доставки
                    deliveryType:
                      type: string
                      enum: [PICKUP, DOOR]
                      description: Тип доставки
                    cdekDeliveryCost:
                      type: number
                      description: Стоимость доставки СДЭК (опционально)
                    deliveryCost:
                      type: number
                      description: Стоимость доставки (опционально)
                    deliveryPointName:
                      type: string
                      description: Название пункта выдачи (опционально)
      x-yc-apigateway-integration:
        type: cloud_functions
        function_id: d4epu4u7dq6u9ni5tfbo
        service_account_id: aje47rf2630q59equess
      responses:
        '200':
          description: Уведомление успешно отправлено или пропущено
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                  notificationSent:
                    type: boolean
                    description: true если уведомление отправлено, false если пользователь не имеет telegramId
                  telegramId:
                    type: string
                    description: Telegram ID пользователя (если отправлено)
                  orderId:
                    type: string
                    description: ID заказа
        '400':
          description: Отсутствует orderData или customerEmail
        '500':
          description: Ошибка сервера
    options:
      summary: CORS preflight
      operationId: sendOrderToUserTelegramOptions
      x-yc-apigateway-integration:
        type: dummy
        http_code: 200
        http_headers:
          Access-Control-Allow-Origin: "'*'"
          Access-Control-Allow-Methods: "'POST, OPTIONS'"
          Access-Control-Allow-Headers: "'Content-Type, Authorization'"
      responses:
        '200':
          description: CORS response

  # Привязка Telegram к email аккаунту
  /api/users/attach-telegram:
    post:
      summary: Привязать Telegram к email аккаунту
      description: Позволяет пользователю, зарегистрированному через email, добавить Telegram к своему аккаунту
      operationId: attachTelegram
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - token
                - initData
              properties:
                token:
                  type: string
                  description: JWT токен пользователя
                initData:
                  type: string
                  description: Данные от Telegram Web App (window.Telegram.WebApp.initData)
      x-yc-apigateway-integration:
        type: cloud_functions
        function_id: ATTACH_TELEGRAM_FUNCTION_ID
        service_account_id: aje47rf2630q59equess
      responses:
        '200':
          description: Telegram успешно привязан
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                  token:
                    type: string
                  user:
                    type: object
        '400':
          description: Ошибка валидации
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
        '401':
          description: Неверный или истекший токен
        '500':
          description: Ошибка сервера
    options:
      summary: CORS preflight
      operationId: attachTelegramOptions
      x-yc-apigateway-integration:
        type: dummy
        http_code: 200
        http_headers:
          Access-Control-Allow-Origin: "'*'"
          Access-Control-Allow-Methods: "'POST, OPTIONS'"
          Access-Control-Allow-Headers: "'Content-Type, Authorization'"
      responses:
        '200':
          description: CORS response

  # Привязка Email к Telegram аккаунту
  /api/users/attach-email:
    post:
      summary: Привязать Email к Telegram аккаунту
      description: Позволяет пользователю, зарегистрированному через Telegram, добавить Email к своему аккаунту
      operationId: attachEmail
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - token
                - email
                - password
                - passwordConfirm
              properties:
                token:
                  type: string
                  description: JWT токен пользователя
                email:
                  type: string
                  format: email
                  description: Email для привязки
                password:
                  type: string
                  description: Пароль (минимум 6 символов)
                passwordConfirm:
                  type: string
                  description: Подтверждение пароля
      x-yc-apigateway-integration:
        type: cloud_functions
        function_id: ATTACH_EMAIL_FUNCTION_ID
        service_account_id: aje47rf2630q59equess
      responses:
        '200':
          description: Email успешно привязан
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                  token:
                    type: string
                  user:
                    type: object
        '400':
          description: Ошибка валидации
        '401':
          description: Неверный или истекший токен
        '500':
          description: Ошибка сервера
    options:
      summary: CORS preflight
      operationId: attachEmailOptions
      x-yc-apigateway-integration:
        type: dummy
        http_code: 200
        http_headers:
          Access-Control-Allow-Origin: "'*'"
          Access-Control-Allow-Methods: "'POST, OPTIONS'"
          Access-Control-Allow-Headers: "'Content-Type, Authorization'"
      responses:
        '200':
          description: CORS response

  # Отвязка Email от аккаунта
  /api/users/detach-email:
    post:
      summary: Отвязать Email от аккаунта
      description: Позволяет пользователю отвязать Email от своего аккаунта, оставляя только Telegram привязку
      operationId: detachEmail
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - token
              properties:
                token:
                  type: string
                  description: JWT токен пользователя
      x-yc-apigateway-integration:
        type: cloud_functions
        function_id: d4em448d4dij6i8dvv23
        service_account_id: aje47rf2630q59equess
      responses:
        '200':
          description: Email успешно отвязан
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                  token:
                    type: string
                  user:
                    type: object
        '400':
          description: Email не привязан к аккаунту
        '401':
          description: Неверный или истекший токен
        '500':
          description: Ошибка сервера
    options:
      summary: CORS preflight
      operationId: detachEmailOptions
      x-yc-apigateway-integration:
        type: dummy
        http_code: 200
        http_headers:
          Access-Control-Allow-Origin: "'*'"
          Access-Control-Allow-Methods: "'POST, OPTIONS'"
          Access-Control-Allow-Headers: "'Content-Type, Authorization'"
      responses:
        '200':
          description: CORS response

  # Отвязка Telegram от аккаунта
  /api/users/detach-telegram:
    post:
      summary: Отвязать Telegram от аккаунта
      description: Позволяет пользователю отвязать Telegram от своего аккаунта, оставляя только Email привязку
      operationId: detachTelegram
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - token
              properties:
                token:
                  type: string
                  description: JWT токен пользователя
      x-yc-apigateway-integration:
        type: cloud_functions
        function_id: d4e09g29gals7tov7gje
        service_account_id: aje47rf2630q59equess
      responses:
        '200':
          description: Telegram успешно отвязан
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                  token:
                    type: string
                  user:
                    type: object
        '400':
          description: Telegram не привязан к аккаунту
        '401':
          description: Неверный или истекший токен
        '500':
          description: Ошибка сервера
    options:
      summary: CORS preflight
      operationId: detachTelegramOptions
      x-yc-apigateway-integration:
        type: dummy
        http_code: 200
        http_headers:
          Access-Control-Allow-Origin: "'*'"
          Access-Control-Allow-Methods: "'POST, OPTIONS'"
          Access-Control-Allow-Headers: "'Content-Type, Authorization'"
      responses:
        '200':
          description: CORS response

  # Изменение пароля
  /api/users/change-password:
    post:
      summary: Изменить пароль
      description: Позволяет пользователю изменить пароль своего аккаунта
      operationId: changePassword
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - token
                - oldPassword
                - newPassword
                - newPasswordConfirm
              properties:
                token:
                  type: string
                  description: JWT токен пользователя
                oldPassword:
                  type: string
                  description: Текущий пароль
                newPassword:
                  type: string
                  description: Новый пароль (минимум 6 символов)
                newPasswordConfirm:
                  type: string
                  description: Подтверждение нового пароля
      x-yc-apigateway-integration:
        type: cloud_functions
        function_id: CHANGE_PASSWORD_FUNCTION_ID
        service_account_id: aje47rf2630q59equess
      responses:
        '200':
          description: Пароль успешно изменён
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                  token:
                    type: string
                  user:
                    type: object
        '400':
          description: Ошибка валидации
        '401':
          description: Неверный пароль или истекший токен
        '500':
          description: Ошибка сервера
    options:
      summary: CORS preflight
      operationId: changePasswordOptions
      x-yc-apigateway-integration:
        type: dummy
        http_code: 200
        http_headers:
          Access-Control-Allow-Origin: "'*'"
          Access-Control-Allow-Methods: "'POST, OPTIONS'"
          Access-Control-Allow-Headers: "'Content-Type, Authorization'"
      responses:
        '200':
          description: CORS response
