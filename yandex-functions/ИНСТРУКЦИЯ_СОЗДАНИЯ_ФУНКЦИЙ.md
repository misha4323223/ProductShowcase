# üìù –ü–û–î–†–û–ë–ù–ê–Ø –ò–ù–°–¢–†–£–ö–¶–ò–Ø: –°–æ–∑–¥–∞–Ω–∏–µ Cloud Functions –≤—Ä—É—á–Ω—É—é

## üéØ –í–∞–º –Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å 4 —Ñ—É–Ω–∫—Ü–∏–∏

1. **calculate-delivery-yandex** - —Ä–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –¥–æ—Å—Ç–∞–≤–∫–∏
2. **create-yandex-order** - —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞—è–≤–∫–∏
3. **track-yandex-order** - –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∑–∞—è–≤–∫–∏
4. **cancel-yandex-order** - –æ—Ç–º–µ–Ω–∞ –∑–∞—è–≤–∫–∏

---

# üì¶ –§–£–ù–ö–¶–ò–Ø 1: calculate-delivery-yandex

## –®–∞–≥ 1.1: –û—Ç–∫—Ä–æ–π—Ç–µ Yandex Cloud Console

1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞: https://console.cloud.yandex.ru
2. –í–æ–π–¥–∏—Ç–µ –≤ —Å–≤–æ–π –∞–∫–∫–∞—É–Ω—Ç
3. –í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à –∫–∞—Ç–∞–ª–æ–≥ (folder)
4. –í –ª–µ–≤–æ–º –º–µ–Ω—é –≤—ã–±–µ—Ä–∏—Ç–µ **"Cloud Functions"**

## –®–∞–≥ 1.2: –°–æ–∑–¥–∞–π—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é

1. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É **"–°–æ–∑–¥–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é"** (–±–æ–ª—å—à–∞—è —Å–∏–Ω—è—è –∫–Ω–æ–ø–∫–∞)
2. –í –ø–æ–ª–µ **"–ò–º—è"** –≤–≤–µ–¥–∏—Ç–µ: `calculate-delivery-yandex`
3. –í –ø–æ–ª–µ **"–û–ø–∏—Å–∞–Ω–∏–µ"** –≤–≤–µ–¥–∏—Ç–µ: `–†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –¥–æ—Å—Ç–∞–≤–∫–∏ –Ø–Ω–¥–µ–∫—Å.–î–æ—Å—Ç–∞–≤–∫–∞`
4. –ù–∞–∂–º–∏—Ç–µ **"–°–æ–∑–¥–∞—Ç—å"** –≤–Ω–∏–∑—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã

## –®–∞–≥ 1.3: –ù–∞—Å—Ç—Ä–æ–π—Ç–µ —Ä–µ–¥–∞–∫—Ç–æ—Ä –∫–æ–¥–∞

1. –í—ã –ø–æ–ø–∞–¥–µ—Ç–µ –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä –∫–æ–¥–∞
2. –ù–∞–π–¥–∏—Ç–µ –≤—ã–ø–∞–¥–∞—é—â–µ–µ –º–µ–Ω—é **"–°—Ä–µ–¥–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è"** (Runtime)
3. –í—ã–±–µ—Ä–∏—Ç–µ: **nodejs18**
4. –ù–∞–π–¥–∏—Ç–µ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å **"–°–ø–æ—Å–æ–±"**
5. –í—ã–±–µ—Ä–∏—Ç–µ: **"–†–µ–¥–∞–∫—Ç–æ—Ä –∫–æ–¥–∞"**

## –®–∞–≥ 1.4: –°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª index.js

1. –í –ª–µ–≤–æ–π –ø–∞–Ω–µ–ª–∏ –≤—ã —É–≤–∏–¥–∏—Ç–µ —Ñ–∞–π–ª `index.js`
2. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –Ω–µ–≥–æ
3. **–£–î–ê–õ–ò–¢–ï** –≤–µ—Å—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥
4. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∏ –≤—Å—Ç–∞–≤—å—Ç–µ —Å–ª–µ–¥—É—é—â–∏–π –∫–æ–¥:

```javascript
/**
 * –§—É–Ω–∫—Ü–∏—è —Ä–∞—Å—á–µ—Ç–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –¥–æ—Å—Ç–∞–≤–∫–∏ –Ø–Ω–¥–µ–∫—Å.–î–æ—Å—Ç–∞–≤–∫–∞
 * –†–∞–±–æ—Ç–∞–µ—Ç –æ–¥–∏–Ω–∞–∫–æ–≤–æ –¥–ª—è —Å–∞–º–æ–∑–∞–Ω—è—Ç—ã—Ö –∏ –ò–ü
 */

const { YandexDeliveryClient } = require('./lib/yandex-delivery-client');

exports.handler = async (event) => {
  try {
    // –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
    const token = process.env.YANDEX_DELIVERY_TOKEN;
    const platformStationId = process.env.YANDEX_PLATFORM_STATION_ID;
    const isTest = process.env.YANDEX_DELIVERY_TEST_MODE === 'true';

    if (!token) {
      return {
        statusCode: 500,
        headers: {
          'Access-Control-Allow-Origin': '*',
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ 
          error: 'Yandex Delivery API token not configured' 
        }),
      };
    }

    // –ü–∞—Ä—Å–∏–º –¥–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å–∞
    const requestData = JSON.parse(event.body || '{}');
    const { 
      items,
      route_points,
      client_requirements
    } = requestData;

    // –í–∞–ª–∏–¥–∞—Ü–∏—è
    if (!items || !Array.isArray(items) || items.length === 0) {
      return {
        statusCode: 400,
        headers: {
          'Access-Control-Allow-Origin': '*',
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ 
          error: 'Missing or invalid items array' 
        }),
      };
    }

    if (!route_points || !Array.isArray(route_points) || route_points.length < 2) {
      return {
        statusCode: 400,
        headers: {
          'Access-Control-Allow-Origin': '*',
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ 
          error: 'route_points must contain at least 2 points (source and destination)' 
        }),
      };
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–ª–∏–µ–Ω—Ç –Ø–Ω–¥–µ–∫—Å.–î–æ—Å—Ç–∞–≤–∫–∏
    const yandexDelivery = new YandexDeliveryClient(token, platformStationId, isTest);

    // –§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞
    const calculationParams = {
      items,
      route_points,
      requirements: client_requirements || {}
    };

    // –ü–æ–ª—É—á–∞–µ–º —Ä–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏
    const result = await yandexDelivery.calculateDelivery(calculationParams);

    return {
      statusCode: 200,
      headers: {
        'Access-Control-Allow-Origin': '*',
        'Access-Control-Allow-Methods': 'POST, OPTIONS',
        'Access-Control-Allow-Headers': 'Content-Type, Authorization',
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        success: true,
        data: result
      }),
    };

  } catch (error) {
    console.error('Error calculating Yandex Delivery cost:', error);
    
    // Sanitize error response
    const errorResponse = {
      error: error.message || 'Failed to calculate delivery cost',
      statusCode: error.statusCode,
      code: error.code
    };
    
    if (error.errors) {
      errorResponse.errors = error.errors;
    }
    
    return {
      statusCode: error.statusCode || 500,
      headers: {
        'Access-Control-Allow-Origin': '*',
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(errorResponse),
    };
  }
};
```

## –®–∞–≥ 1.5: –°–æ–∑–¥–∞–π—Ç–µ –ø–∞–ø–∫—É lib

1. –ü–æ–¥ —Ñ–∞–π–ª–æ–º `index.js` –Ω–∞–π–¥–∏—Ç–µ –∫–Ω–æ–ø–∫—É **"–°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª"** (–∏–ª–∏ –∑–Ω–∞—á–æ–∫ **+**)
2. –í –ø–æ—è–≤–∏–≤—à–µ–º—Å—è –æ–∫–Ω–µ –≤–≤–µ–¥–∏—Ç–µ: `lib/yandex-delivery-client.js`
3. –ù–∞–∂–º–∏—Ç–µ **"–°–æ–∑–¥–∞—Ç—å"**

## –®–∞–≥ 1.6: –î–æ–±–∞–≤—å—Ç–µ –∫–æ–¥ –≤ lib/yandex-delivery-client.js

1. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ —Ñ–∞–π–ª `lib/yandex-delivery-client.js`
2. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∏ –≤—Å—Ç–∞–≤—å—Ç–µ —Å–ª–µ–¥—É—é—â–∏–π –∫–æ–¥:

```javascript
/**
 * –Ø–Ω–¥–µ–∫—Å.–î–æ—Å—Ç–∞–≤–∫–∞ API Client
 * –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –Ø–Ω–¥–µ–∫—Å.–î–æ—Å—Ç–∞–≤–∫–∞ API
 * –†–∞–±–æ—Ç–∞–µ—Ç –æ–¥–∏–Ω–∞–∫–æ–≤–æ –¥–ª—è —Å–∞–º–æ–∑–∞–Ω—è—Ç—ã—Ö –∏ –ò–ü - —Ç—Ä–µ–±—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ —Å–º–µ–Ω–∞ —Ç–æ–∫–µ–Ω–∞
 */

const https = require('https');

class YandexDeliveryClient {
  constructor(token, platformStationId, isTest = false) {
    this.token = token;
    this.platformStationId = platformStationId;
    this.baseUrl = isTest 
      ? 'https://b2b.taxi.tst.yandex.net' 
      : 'https://b2b.taxi.yandex.net';
  }

  async calculateDelivery(params) {
    return this._request('POST', '/api/b2b/platform/offers/create', params);
  }

  async createClaim(claimData) {
    return this._request('POST', '/api/b2b/platform/claims/create', claimData);
  }

  async getClaimInfo(claimId) {
    return this._request('POST', '/api/b2b/platform/claims/info', {
      claim_id: claimId
    });
  }

  async getCancelInfo(claimId) {
    return this._request('POST', '/api/b2b/platform/claims/cancel-info', {
      claim_id: claimId
    });
  }

  async cancelClaim(claimId, version, cancel_state) {
    if (!cancel_state || typeof cancel_state !== 'string') {
      throw new Error('cancel_state must be a valid string from cancel-info response');
    }
    
    return this._request('POST', '/api/b2b/platform/claims/cancel', {
      claim_id: claimId,
      version: version,
      cancel_state: cancel_state
    });
  }

  _request(method, path, body = null) {
    return new Promise((resolve, reject) => {
      const url = new URL(this.baseUrl + path);
      
      const headers = {
        'Authorization': `Bearer ${this.token}`,
        'Content-Type': 'application/json',
        'Accept-Language': 'ru'
      };

      if (this.platformStationId && (path.includes('/offers/') || path.includes('/claims/'))) {
        headers['X-B2B-Client-Storage'] = JSON.stringify({
          platform_station_id: this.platformStationId
        });
      }

      const options = {
        hostname: url.hostname,
        path: url.pathname + url.search,
        method: method,
        headers: headers
      };

      const req = https.request(options, (res) => {
        let data = '';

        res.on('data', (chunk) => {
          data += chunk;
        });

        res.on('end', () => {
          try {
            const parsed = JSON.parse(data);
            
            if (res.statusCode >= 200 && res.statusCode < 300) {
              resolve(parsed);
            } else {
              const errorResponse = {
                statusCode: res.statusCode,
                message: parsed.message || parsed.error || 'Request failed',
                code: parsed.code || null
              };
              
              if (parsed.errors && Array.isArray(parsed.errors)) {
                errorResponse.errors = parsed.errors;
              }
              
              reject(errorResponse);
            }
          } catch (error) {
            reject({
              statusCode: res.statusCode,
              error: 'Failed to parse response',
              rawData: data
            });
          }
        });
      });

      req.on('error', (error) => {
        reject(error);
      });

      if (body && method !== 'GET') {
        req.write(JSON.stringify(body));
      }

      req.end();
    });
  }
}

module.exports = { YandexDeliveryClient };
```

## –®–∞–≥ 1.7: –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ—É–Ω–∫—Ü–∏–∏

1. –ü—Ä–æ–∫—Ä—É—Ç–∏—Ç–µ –≤–Ω–∏–∑ –¥–æ —Ä–∞–∑–¥–µ–ª–∞ **"–ü–∞—Ä–∞–º–µ—Ç—Ä—ã"**
2. –ù–∞–π–¥–∏—Ç–µ –ø–æ–ª–µ **"–¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞"** –∏ –≤–≤–µ–¥–∏—Ç–µ: `index.handler`
3. –ù–∞–π–¥–∏—Ç–µ –ø–æ–ª–µ **"–¢–∞–π–º–∞—É—Ç, —Å"** –∏ –≤–≤–µ–¥–∏—Ç–µ: `30`
4. –ù–∞–π–¥–∏—Ç–µ –ø–æ–ª–µ **"–ü–∞–º—è—Ç—å"** –∏ –≤—ã–±–µ—Ä–∏—Ç–µ: `128 –ú–ë`

## –®–∞–≥ 1.8: –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

1. –ù–∞–π–¥–∏—Ç–µ —Ä–∞–∑–¥–µ–ª **"–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è"**
2. –ù–∞–∂–º–∏—Ç–µ **"–î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é"**
3. –î–æ–±–∞–≤—å—Ç–µ **3 –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ**:

**–ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è 1:**
- –ö–ª—é—á: `YANDEX_DELIVERY_TOKEN`
- –ó–Ω–∞—á–µ–Ω–∏–µ: `y2_AgAAAAD04omrAAAPeAAAAAACRpC94Qk6Z5rUTgOcTgYFECJllXYKFx8`

**–ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è 2:**
- –ö–ª—é—á: `YANDEX_PLATFORM_STATION_ID`
- –ó–Ω–∞—á–µ–Ω–∏–µ: `fbed3aa1-2cc6-4370-ab4d-59c5cc9bb924`

**–ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è 3:**
- –ö–ª—é—á: `YANDEX_DELIVERY_TEST_MODE`
- –ó–Ω–∞—á–µ–Ω–∏–µ: `true`

## –®–∞–≥ 1.9: –°–æ–∑–¥–∞–π—Ç–µ –≤–µ—Ä—Å–∏—é

1. –ü—Ä–æ–∫—Ä—É—Ç–∏—Ç–µ –≤–Ω–∏–∑
2. –ù–∞–∂–º–∏—Ç–µ –±–æ–ª—å—à—É—é —Å–∏–Ω—é—é –∫–Ω–æ–ø–∫—É **"–°–æ–∑–¥–∞—Ç—å –≤–µ—Ä—Å–∏—é"**
3. –î–æ–∂–¥–∏—Ç–µ—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è (–ø–æ—è–≤–∏—Ç—Å—è –∑–µ–ª–µ–Ω–∞—è –≥–∞–ª–æ—á–∫–∞)

## –®–∞–≥ 1.10: –°–¥–µ–ª–∞–π—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é –ø—É–±–ª–∏—á–Ω–æ–π

1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤–æ –≤–∫–ª–∞–¥–∫—É **"–û–±–∑–æ—Ä"** (–≤–≤–µ—Ä—Ö—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã)
2. –ù–∞–π–¥–∏—Ç–µ —Ä–∞–∑–¥–µ–ª **"–ü—É–±–ª–∏—á–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è"**
3. –ù–∞–∂–º–∏—Ç–µ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å, —á—Ç–æ–±—ã **–≤–∫–ª—é—á–∏—Ç—å** –ø—É–±–ª–∏—á–Ω—ã–π –¥–æ—Å—Ç—É–ø
4. **–í–ê–ñ–ù–û**: –°–∫–æ–ø–∏—Ä—É–π—Ç–µ **"URL –≤—ã–∑–æ–≤–∞"** –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –µ–≥–æ!
   - –û–Ω –±—É–¥–µ—Ç –≤—ã–≥–ª—è–¥–µ—Ç—å –ø—Ä–∏–º–µ—Ä–Ω–æ —Ç–∞–∫: `https://functions.yandexcloud.net/d4e...abc`

‚úÖ **–§–£–ù–ö–¶–ò–Ø 1 –ì–û–¢–û–í–ê!**

---

# üì¶ –§–£–ù–ö–¶–ò–Ø 2: create-yandex-order

–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –≤—Å–µ —à–∞–≥–∏ –∏–∑ –§–£–ù–ö–¶–ò–ò 1, –Ω–æ —Å –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏:

## –®–∞–≥ 2.1: –°–æ–∑–¥–∞–π—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é
- **–ò–º—è**: `create-yandex-order`
- **–û–ø–∏—Å–∞–Ω–∏–µ**: `–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞—è–≤–∫–∏ –≤ –Ø–Ω–¥–µ–∫—Å.–î–æ—Å—Ç–∞–≤–∫–∞`

## –®–∞–≥ 2.2: –ö–æ–¥ –¥–ª—è index.js

```javascript
/**
 * –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞—è–≤–∫–∏ –≤ –Ø–Ω–¥–µ–∫—Å.–î–æ—Å—Ç–∞–≤–∫–∞
 * –†–∞–±–æ—Ç–∞–µ—Ç –æ–¥–∏–Ω–∞–∫–æ–≤–æ –¥–ª—è —Å–∞–º–æ–∑–∞–Ω—è—Ç—ã—Ö –∏ –ò–ü
 */

const { YandexDeliveryClient } = require('./lib/yandex-delivery-client');

exports.handler = async (event) => {
  try {
    const token = process.env.YANDEX_DELIVERY_TOKEN;
    const platformStationId = process.env.YANDEX_PLATFORM_STATION_ID;
    const isTest = process.env.YANDEX_DELIVERY_TEST_MODE === 'true';

    if (!token) {
      return {
        statusCode: 500,
        headers: {
          'Access-Control-Allow-Origin': '*',
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ 
          error: 'Yandex Delivery API token not configured' 
        }),
      };
    }

    const claimData = JSON.parse(event.body || '{}');
    const { items, route_points } = claimData;

    if (!items || !Array.isArray(items) || items.length === 0) {
      return {
        statusCode: 400,
        headers: {
          'Access-Control-Allow-Origin': '*',
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ 
          error: 'items must be a non-empty array' 
        }),
      };
    }

    if (!route_points || !Array.isArray(route_points) || route_points.length < 2) {
      return {
        statusCode: 400,
        headers: {
          'Access-Control-Allow-Origin': '*',
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ 
          error: 'route_points must contain at least 2 points' 
        }),
      };
    }

    for (const point of route_points) {
      if (!point.coordinates || !Array.isArray(point.coordinates) || point.coordinates.length !== 2) {
        return {
          statusCode: 400,
          headers: {
            'Access-Control-Allow-Origin': '*',
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ 
            error: 'Each route_point must have coordinates array [longitude, latitude]' 
          }),
        };
      }
    }

    const yandexDelivery = new YandexDeliveryClient(token, platformStationId, isTest);
    const result = await yandexDelivery.createClaim(claimData);

    return {
      statusCode: 200,
      headers: {
        'Access-Control-Allow-Origin': '*',
        'Access-Control-Allow-Methods': 'POST, OPTIONS',
        'Access-Control-Allow-Headers': 'Content-Type, Authorization',
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        success: true,
        data: result
      }),
    };

  } catch (error) {
    console.error('Error creating Yandex Delivery claim:', error);
    
    const errorResponse = {
      error: error.message || 'Failed to create Yandex Delivery claim',
      statusCode: error.statusCode,
      code: error.code
    };
    
    if (error.errors) {
      errorResponse.errors = error.errors;
    }
    
    return {
      statusCode: error.statusCode || 500,
      headers: {
        'Access-Control-Allow-Origin': '*',
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(errorResponse),
    };
  }
};
```

## –®–∞–≥ 2.3: –ö–æ–¥ –¥–ª—è lib/yandex-delivery-client.js
**–¢–û–ß–ù–û –¢–ê–ö–û–ô –ñ–ï** –∫–∞–∫ –≤ –§–£–ù–ö–¶–ò–ò 1

## –®–∞–≥ 2.4: –û—Å—Ç–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
- –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞: `index.handler`
- –¢–∞–π–º–∞—É—Ç: `30`
- –ü–∞–º—è—Ç—å: `128 –ú–ë`
- –¢–µ –∂–µ 3 –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
- –°–æ–∑–¥–∞—Ç—å –≤–µ—Ä—Å–∏—é
- –°–¥–µ–ª–∞—Ç—å –ø—É–±–ª–∏—á–Ω–æ–π
- **–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å URL –≤—ã–∑–æ–≤–∞!**

‚úÖ **–§–£–ù–ö–¶–ò–Ø 2 –ì–û–¢–û–í–ê!**

---

# üì¶ –§–£–ù–ö–¶–ò–Ø 3: track-yandex-order

## –®–∞–≥ 3.1: –°–æ–∑–¥–∞–π—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é
- **–ò–º—è**: `track-yandex-order`
- **–û–ø–∏—Å–∞–Ω–∏–µ**: `–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∑–∞—è–≤–∫–∏ –≤ –Ø–Ω–¥–µ–∫—Å.–î–æ—Å—Ç–∞–≤–∫–∞`

## –®–∞–≥ 3.2: –ö–æ–¥ –¥–ª—è index.js

```javascript
/**
 * –§—É–Ω–∫—Ü–∏—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∑–∞—è–≤–∫–∏ –≤ –Ø–Ω–¥–µ–∫—Å.–î–æ—Å—Ç–∞–≤–∫–∞
 * –†–∞–±–æ—Ç–∞–µ—Ç –æ–¥–∏–Ω–∞–∫–æ–≤–æ –¥–ª—è —Å–∞–º–æ–∑–∞–Ω—è—Ç—ã—Ö –∏ –ò–ü
 */

const { YandexDeliveryClient } = require('./lib/yandex-delivery-client');

exports.handler = async (event) => {
  try {
    const token = process.env.YANDEX_DELIVERY_TOKEN;
    const platformStationId = process.env.YANDEX_PLATFORM_STATION_ID;
    const isTest = process.env.YANDEX_DELIVERY_TEST_MODE === 'true';

    if (!token) {
      return {
        statusCode: 500,
        headers: {
          'Access-Control-Allow-Origin': '*',
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ 
          error: 'Yandex Delivery API token not configured' 
        }),
      };
    }

    let claimId;
    
    if (event.queryStringParameters && event.queryStringParameters.claim_id) {
      claimId = event.queryStringParameters.claim_id;
    } else if (event.body) {
      const requestData = JSON.parse(event.body);
      claimId = requestData.claim_id;
    }

    if (!claimId) {
      return {
        statusCode: 400,
        headers: {
          'Access-Control-Allow-Origin': '*',
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ 
          error: 'claim_id is required' 
        }),
      };
    }

    const yandexDelivery = new YandexDeliveryClient(token, platformStationId, isTest);
    const result = await yandexDelivery.getClaimInfo(claimId);

    return {
      statusCode: 200,
      headers: {
        'Access-Control-Allow-Origin': '*',
        'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',
        'Access-Control-Allow-Headers': 'Content-Type, Authorization',
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        success: true,
        data: result
      }),
    };

  } catch (error) {
    console.error('Error tracking Yandex Delivery claim:', error);
    
    const errorResponse = {
      error: error.message || 'Failed to track Yandex Delivery claim',
      statusCode: error.statusCode,
      code: error.code
    };
    
    if (error.errors) {
      errorResponse.errors = error.errors;
    }
    
    return {
      statusCode: error.statusCode || 500,
      headers: {
        'Access-Control-Allow-Origin': '*',
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(errorResponse),
    };
  }
};
```

## –®–∞–≥ 3.3: –û—Å—Ç–∞–ª—å–Ω–æ–µ
- –¢–æ—Ç –∂–µ `lib/yandex-delivery-client.js`
- –¢–µ –∂–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
- –°–æ–∑–¥–∞—Ç—å –≤–µ—Ä—Å–∏—é
- –°–¥–µ–ª–∞—Ç—å –ø—É–±–ª–∏—á–Ω–æ–π
- **–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å URL!**

‚úÖ **–§–£–ù–ö–¶–ò–Ø 3 –ì–û–¢–û–í–ê!**

---

# üì¶ –§–£–ù–ö–¶–ò–Ø 4: cancel-yandex-order

## –®–∞–≥ 4.1: –°–æ–∑–¥–∞–π—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é
- **–ò–º—è**: `cancel-yandex-order`
- **–û–ø–∏—Å–∞–Ω–∏–µ**: `–û—Ç–º–µ–Ω–∞ –∑–∞—è–≤–∫–∏ –≤ –Ø–Ω–¥–µ–∫—Å.–î–æ—Å—Ç–∞–≤–∫–∞`

## –®–∞–≥ 4.2: –ö–æ–¥ –¥–ª—è index.js

```javascript
/**
 * –§—É–Ω–∫—Ü–∏—è –æ—Ç–º–µ–Ω—ã –∑–∞—è–≤–∫–∏ –≤ –Ø–Ω–¥–µ–∫—Å.–î–æ—Å—Ç–∞–≤–∫–∞
 * –†–∞–±–æ—Ç–∞–µ—Ç –æ–¥–∏–Ω–∞–∫–æ–≤–æ –¥–ª—è —Å–∞–º–æ–∑–∞–Ω—è—Ç—ã—Ö –∏ –ò–ü
 */

const { YandexDeliveryClient } = require('./lib/yandex-delivery-client');

exports.handler = async (event) => {
  try {
    const token = process.env.YANDEX_DELIVERY_TOKEN;
    const platformStationId = process.env.YANDEX_PLATFORM_STATION_ID;
    const isTest = process.env.YANDEX_DELIVERY_TEST_MODE === 'true';

    if (!token) {
      return {
        statusCode: 500,
        headers: {
          'Access-Control-Allow-Origin': '*',
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ 
          error: 'Yandex Delivery API token not configured' 
        }),
      };
    }

    const requestData = JSON.parse(event.body || '{}');
    const { claim_id, version } = requestData;

    if (!claim_id) {
      return {
        statusCode: 400,
        headers: {
          'Access-Control-Allow-Origin': '*',
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ 
          error: 'claim_id is required' 
        }),
      };
    }

    const yandexDelivery = new YandexDeliveryClient(token, platformStationId, isTest);

    const cancelInfoResponse = await yandexDelivery.getCancelInfo(claim_id);
    
    let cancelState = null;
    if (cancelInfoResponse.cancel_state) {
      cancelState = cancelInfoResponse.cancel_state;
    } else if (cancelInfoResponse.cancel_info && cancelInfoResponse.cancel_info.cancel_state) {
      cancelState = cancelInfoResponse.cancel_info.cancel_state;
    } else if (cancelInfoResponse.cancel_details && cancelInfoResponse.cancel_details.cancel_state) {
      cancelState = cancelInfoResponse.cancel_details.cancel_state;
    }
    
    if (!cancelState) {
      return {
        statusCode: 400,
        headers: {
          'Access-Control-Allow-Origin': '*',
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ 
          error: 'Cannot cancel: no valid cancel_state available',
          cancelInfo: cancelInfoResponse
        }),
      };
    }

    let claimVersion = version;
    if (!claimVersion) {
      const claimInfo = await yandexDelivery.getClaimInfo(claim_id);
      claimVersion = claimInfo.version;
    }

    const result = await yandexDelivery.cancelClaim(claim_id, claimVersion, cancelState);

    return {
      statusCode: 200,
      headers: {
        'Access-Control-Allow-Origin': '*',
        'Access-Control-Allow-Methods': 'POST, OPTIONS',
        'Access-Control-Allow-Headers': 'Content-Type, Authorization',
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        success: true,
        cancelInfo: cancelInfoResponse,
        data: result
      }),
    };

  } catch (error) {
    console.error('Error canceling Yandex Delivery claim:', error);
    
    const errorResponse = {
      error: error.message || 'Failed to cancel Yandex Delivery claim',
      statusCode: error.statusCode,
      code: error.code
    };
    
    if (error.errors) {
      errorResponse.errors = error.errors;
    }
    
    return {
      statusCode: error.statusCode || 500,
      headers: {
        'Access-Control-Allow-Origin': '*',
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(errorResponse),
    };
  }
};
```

## –®–∞–≥ 4.3: –û—Å—Ç–∞–ª—å–Ω–æ–µ
- –¢–æ—Ç –∂–µ `lib/yandex-delivery-client.js`
- –¢–µ –∂–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
- –°–æ–∑–¥–∞—Ç—å –≤–µ—Ä—Å–∏—é
- –°–¥–µ–ª–∞—Ç—å –ø—É–±–ª–∏—á–Ω–æ–π
- **–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å URL!**

‚úÖ **–§–£–ù–ö–¶–ò–Ø 4 –ì–û–¢–û–í–ê!**

---

## ‚úÖ –ß–ï–ö–õ–ò–°–¢ –ü–†–û–í–ï–†–ö–ò

–ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –í–°–ï–• 4 —Ñ—É–Ω–∫—Ü–∏–π, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:

- [ ] –í—Å–µ 4 —Ñ—É–Ω–∫—Ü–∏–∏ —Å–æ–∑–¥–∞–Ω—ã
- [ ] –£ –∫–∞–∂–¥–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ –µ—Å—Ç—å `index.js` –∏ `lib/yandex-delivery-client.js`
- [ ] –£ –∫–∞–∂–¥–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã 3 –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
- [ ] –£ –∫–∞–∂–¥–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞: `index.handler`
- [ ] –í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Å–¥–µ–ª–∞–Ω—ã –ø—É–±–ª–∏—á–Ω—ã–º–∏
- [ ] –£ –≤–∞—Å –µ—Å—Ç—å 4 URL –≤—ã–∑–æ–≤–∞ (–ø–æ –æ–¥–Ω–æ–º—É –¥–ª—è –∫–∞–∂–¥–æ–π —Ñ—É–Ω–∫—Ü–∏–∏)

---

## üéâ –ß–¢–û –î–ê–õ–¨–®–ï?

–ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –≤—Å–µ—Ö —Ñ—É–Ω–∫—Ü–∏–π, –ø–µ—Ä–µ–π–¥–∏—Ç–µ –∫ —Ñ–∞–π–ª—É **"–ß–¢–û_–ù–£–ñ–ù–û_–°–î–ï–õ–ê–¢–¨_–í–ê–ú.md"** - —Ç–∞–º –æ–ø–∏—Å–∞–Ω–æ, –∫–∞–∫ –æ–±–Ω–æ–≤–∏—Ç—å API Gateway –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é!

**–ù–∞–ø–∏—à–∏—Ç–µ –º–Ω–µ –∫–æ–≥–¥–∞ –∑–∞–∫–æ–Ω—á–∏—Ç–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏!**
