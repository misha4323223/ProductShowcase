// –£—Ç–∏–ª–∏—Ç–∞ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–æ–≤ —á–∞—Ç–±–æ—Ç–∞

export interface Product {
  id: string;
  name: string;
  price: number;
  image: string;
  category: string;
}

interface BotResponse {
  text: string;
  products: Product[];
  showWheelButton?: boolean;
}

// –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –Ω–∞–º–µ—Ä–µ–Ω–∏–π
const productCategoryMap = {
  romantic: ['chocolate', 'gift-box'], // –®–æ–∫–æ–ª–∞–¥ –∏ –ø–æ–¥–∞—Ä–æ—á–Ω—ã–µ –Ω–∞–±–æ—Ä—ã
  birthday: ['gift-box', 'candies', 'cookies-pastries'], // –ù–∞–±–æ—Ä—ã, –∫–æ–Ω—Ñ–µ—Ç—ã, –ø–µ—á–µ–Ω—å–µ
  budget: ['candies', 'napitki', 'marmalade'], // –ö–æ–Ω—Ñ–µ—Ç—ã, –Ω–∞–ø–∏—Ç–∫–∏, –º–∞—Ä–º–µ–ª–∞–¥
  premium: ['chocolate', 'gift-box'], // –®–æ–∫–æ–ª–∞–¥ –∏ –ø—Ä–µ–º–∏—É–º –Ω–∞–±–æ—Ä—ã
  noChocolate: ['cookies-pastries', 'candies', 'mochi-marshmallow', 'marmalade'], // –ü–µ—á–µ–Ω—å–µ, –∫–æ–Ω—Ñ–µ—Ç—ã, –º–æ—Ç–∏, –º–∞—Ä–º–µ–ª–∞–¥
};

// –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –Ω–∞–º–µ—Ä–µ–Ω–∏–π
const keywords = {
  romantic: ['—Ä–æ–º–∞–Ω—Ç–∏–∫', '–≤–ª—é–±–ª', '—Å–≤–∏–¥–∞–Ω', '–ª—é–±', '–ø–∞—Ä–∞', '–ª—é–±–æ–≤—å'],
  birthday: ['–¥–µ–Ω—å —Ä–æ–∂–¥–µ–Ω', '–¥–Ω—è —Ä–æ–∂–¥–µ–Ω–∏—è', '–¥–µ–Ω—å —Ä–æ–∂', '—Ä–æ–∂–¥–µ–Ω–∏–µ', '–ø—Ä–∞–∑–¥–Ω–∏–∫', '–ø—Ä–∞–∑–¥–Ω'],
  cheap: ['–¥–µ—à–µ–≤', '–¥–µ—à–µ–≤', '–±—é–¥–∂–µ—Ç', '–±—é–¥–∂–µ—Ç', '–¥–µ–Ω—å–≥–∏', '—Ü–µ–Ω–∞', '–Ω–µ –¥–æ—Ä–æ–≥'],
  premium: ['–ø—Ä–µ–º–∏—É–º', '–ª—é–∫—Å', '—ç–ª–∏—Ç', '–¥–æ—Ä–æ–≥', '—Ñ–µ—à–µ–Ω', '–æ—Å–æ–±', '–∫—Ä—É—Ç–æ–π'],
  noChocolate: ['–±–µ–∑ —à–æ–∫–æ–ª', '–±–µ–∑ –∫–∞–∫–∞–æ', '–Ω–µ –ª—é–± —à–æ–∫–æ–ª', '–∫—Ä–æ–º–µ —à–æ–∫–æ–ª'],
  wheel: ['—Ä—É–ª–µ—Ç–∫', '–∫—Ä–∏—Å—Ç–∞–ª–ª', '–ø—Ä–∏–∑', '–∫—Ä—É—Ç–∏', '–∫–æ–ª–µ—Å', '–≤–µ–∑–µ–Ω–∏', '—É–¥–∞—á–∞', '–¥–∂–µ–∫–ø–æ—Ç', '—Å–∫–∏–¥–∫', '–±–æ–Ω—É—Å', '–ø–æ–¥–∞—Ä–æ–∫'],
  greeting: ['–ø—Ä–∏–≤–µ—Ç', '–∑–¥—Ä–∞–≤—Å—Ç–≤', '–ø—Ä–∏–≤–µ—Ç', 'hi', 'hello', '–∑–¥—Ä–∞–≤', '–∫–∞–∫ –¥–µ–ª–∞'],
};

export function detectIntent(userMessage: string): string {
  const message = userMessage.toLowerCase();

  for (const [intent, keywordsList] of Object.entries(keywords)) {
    if (keywordsList.some(kw => message.includes(kw))) {
      return intent;
    }
  }

  return 'default';
}

export function getResponseText(intent: string): string {
  const responses: Record<string, string> = {
    romantic: '‚ù§Ô∏è –†–µ–∫–æ–º–µ–Ω–¥—É—é –Ω–∞—à–∏ –ø—Ä–µ–º–∏—É–º —Å–ª–∞–¥–æ—Å—Ç–∏ –¥–ª—è —Ä–æ–º–∞–Ω—Ç–∏—á–Ω–æ–≥–æ –≤–µ—á–µ—Ä–∞. –í–æ—Ç –∏–¥–µ–∞–ª—å–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã:',
    birthday: 'üéâ –û—Ç–ª–∏—á–Ω–æ! –í–æ—Ç —á—Ç–æ —è —Å–æ–≤–µ—Ç—É—é –¥–ª—è –ø—Ä–∞–∑–¥–Ω–∏–∫–∞:',
    cheap: 'üí∞ –õ–æ–≤–∫–æ! –í–æ—Ç –±—é–¥–∂–µ—Ç–Ω—ã–µ, –Ω–æ –≤–∫—É—Å–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã:',
    premium: 'üëë –í–æ—Ç –Ω–∞—à–∞ –ø—Ä–µ–º–∏—É–º –∫–æ–ª–ª–µ–∫—Ü–∏—è:',
    noChocolate: 'üç¨ –í–æ—Ç —Å–ª–∞–¥–æ—Å—Ç–∏ –±–µ–∑ —à–æ–∫–æ–ª–∞–¥–∞:',
    wheel: `üé∞ –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –†—É–ª–µ—Ç–∫–∞ –ñ–µ–ª–∞–Ω–∏–π?

üíé –ß—Ç–æ —Ç–∞–∫–æ–µ –∫—Ä–∏—Å—Ç–∞–ª–ª—ã?

–ö—Ä–∏—Å—Ç–∞–ª–ª—ã = –ø–æ–ø—ã—Ç–∫–∏ –∫—Ä—É—Ç–∏—Ç—å —Ä—É–ª–µ—Ç–∫—É

‚Ä¢ 1000‚ÇΩ –ø–æ–∫—É–ø–∫–∏ = 1 –∫—Ä–∏—Å—Ç–∞–ª–ª üíé

üéÅ –ë–æ–ª—å—à–µ –∫—Ä–∏—Å—Ç–∞–ª–ª–æ–≤ = –±–æ–ª—å—à–µ –ø—Ä–∏–∑–æ–≤:

‚Ä¢ 1üíé ‚Üí –°–∫–∏–¥–∫–∞ 10% (–Ω–∞ –≤–µ—Å—å –∑–∞–∫–∞–∑)
‚Ä¢ 2üíé ‚Üí + –¢–æ–≤–∞—Ä -20% (–Ω–∞ —Å–ª—É—á–∞–π–Ω—ã–π —Ç–æ–≤–∞—Ä –≤ –∫–æ—Ä–∑–∏–Ω–µ)
‚Ä¢ 3üíé ‚Üí + –ë–æ–Ω—É—Å—ã +200‚ÇΩ (–Ω–∞ –±–∞–ª–∞–Ω—Å)
‚Ä¢ 4üíé ‚Üí + –î–æ—Å—Ç–∞–≤–∫–∞ –±–µ—Å–ø–ª–∞—Ç–Ω–æ (–Ω–∞ –∑–∞–∫–∞–∑)
‚Ä¢ 5üíé ‚Üí + –¢–æ–≤–∞—Ä –ë–ï–°–ü–õ–ê–¢–ù–û (—Å–∞–º—ã–π –¥–µ—à—ë–≤—ã–π –≤ –∫–æ—Ä–∑–∏–Ω–µ, –¥–æ 500‚ÇΩ)
‚Ä¢ 6+üíé ‚Üí üî• –î–ñ–ï–ö–ü–û–¢ 40% (–Ω–∞ –≤—Å—é –∫–æ—Ä–∑–∏–Ω—É)

üéØ –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç?

–†—É–ª–µ—Ç–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—Å–µ 6 –ø—Ä–∏–∑–æ–≤, –Ω–æ –≤—ã–ø–∞—Å—Ç—å –º–æ–≥—É—Ç —Ç–æ–ª—å–∫–æ —Ç–µ, —á—Ç–æ –¥–æ—Å—Ç—É–ø–Ω—ã –ø–æ –≤–∞—à–∏–º –∫—Ä–∏—Å—Ç–∞–ª–ª–∞–º.

–ü—Ä–∏–º–µ—Ä:

–£ –≤–∞—Å 3üíé ‚Üí –º–æ–∂–µ—Ç–µ –≤—ã–∏–≥—Ä–∞—Ç—å —Å–∫–∏–¥–∫—É 10%, 20% –∏–ª–∏ –±–æ–Ω—É—Å—ã. –î–æ—Å—Ç–∞–≤–∫–∞, –ø–æ–¥–∞—Ä–æ–∫ –∏ –¥–∂–µ–∫–ø–æ—Ç –ø–æ–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã.

‚ùì FAQ:

–í: –ü–æ—Ç—Ä–∞—á—É –∫—Ä–∏—Å—Ç–∞–ª–ª –∑—Ä—è?
–û: –ù–µ—Ç, –≤—ã –í–°–ï–ì–î–ê —á—Ç–æ-—Ç–æ –≤—ã–∏–≥—Ä—ã–≤–∞–µ—Ç–µ!

–í: –ú–æ–∂–Ω–æ –∫–æ–ø–∏—Ç—å?
–û: –î–∞! –ö–æ–ø–∏—Ç–µ –¥–æ 6+ –¥–ª—è –¥–∂–µ–∫–ø–æ—Ç–∞! üíé

–í: –ü–æ—á–µ–º—É –Ω—É–∂–Ω–∞ –∫–æ—Ä–∑–∏–Ω–∞?
–û: –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–∏–∑—ã –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º —Ç–æ–≤–∞—Ä–∞–º –≤ –∫–æ—Ä–∑–∏–Ω–µ üõí`,
    greeting: 'üëã –ü—Ä–∏–≤–µ—Ç! –†–∞–¥ —Ç–µ–±—è –≤–∏–¥–µ—Ç—å. –ß–µ–º —è –º–æ–≥—É –ø–æ–º–æ—á—å? –ù–∞–ø—Ä–∏–º–µ—Ä: "–î–ª—è —Ä–æ–º–∞–Ω—Ç–∏–∫–∏", "–ù–∞ –¥–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è", "–î–µ—à–µ–≤—ã–µ —Å–ª–∞–¥–æ—Å—Ç–∏" –∏–ª–∏ "–†–∞—Å—Å–∫–∞–∂–∏ –æ —Ä—É–ª–µ—Ç–∫–µ"',
    default: 'üòä –ò–Ω—Ç–µ—Ä–µ—Å–Ω–æ! –î–∞–≤–∞–π –ø–æ—Å–º–æ—Ç—Ä–∏–º, —á—Ç–æ —è –º–æ–≥—É –ø–æ—Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞—Ç—å. –ü–æ–∫–∞ —á—Ç–æ –≤–æ—Ç –Ω–∞—à–∏ –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã:',
  };

  return responses[intent] || responses['default'];
}

export function getRecommendedCategories(intent: string): string[] {
  const categories: Record<string, string[]> = {
    romantic: productCategoryMap.romantic,
    birthday: productCategoryMap.birthday,
    cheap: productCategoryMap.budget,
    premium: productCategoryMap.premium,
    noChocolate: productCategoryMap.noChocolate,
    wheel: [], // –ù–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ä—É–ª–µ—Ç–∫–µ
    greeting: productCategoryMap.premium,
    default: ['chocolate', 'gift-box', 'candies'],
  };

  return categories[intent] || categories['default'];
}

export function generateBotResponse(userMessage: string, allProducts: Product[]): BotResponse {
  const intent = detectIntent(userMessage);
  const responseText = getResponseText(intent);
  const recommendedCategories = getRecommendedCategories(intent);

  // –ï—Å–ª–∏ —ç—Ç–æ –ø—Ä–æ —Ä—É–ª–µ—Ç–∫—É, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –≤–º–µ—Å—Ç–æ —Ç–æ–≤–∞—Ä–æ–≤
  if (intent === 'wheel') {
    return {
      text: responseText,
      products: [],
      showWheelButton: true,
    };
  }

  // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–≤–∞—Ä—ã –ø–æ —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω—ã–º –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
  const recommendedProducts = allProducts.filter(product =>
    recommendedCategories.includes(product.category)
  );

  // –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞—à–ª–∏, –±–µ—Ä—ë–º –≤—Å–µ —Ç–æ–≤–∞—Ä—ã
  const finalProducts = recommendedProducts.length > 0 
    ? recommendedProducts 
    : allProducts;

  return {
    text: responseText,
    products: finalProducts.slice(0, 4), // –ú–∞–∫—Å–∏–º—É–º 4 —Ç–æ–≤–∞—Ä–∞
  };
}
